<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        function Promise(executor) {
            this.PromiseState = 'pending';
            this.PromiseResult = null;
            this.callbacks = []
            const self = this
            function resolve(data) {
                if (self.PromiseState !== 'pending') return;
                self.PromiseState = 'fulfilled';
                self.PromiseResult = data;
                setTimeout(() => {
                    self.callbacks.forEach((item) => {
                        item.onResolved(data)
                    })
                })
            }
            function reject(data) {
                if (self.PromiseState !== 'pending') return;
                self.PromiseState = 'rejected';
                self.PromiseResult = data;
                setTimeout(() => {
                    self.callbacks.forEach((item) => {
                        item.onRejected(data)
                    })
                })
            }
            try {
                executor(resolve, reject);
            } catch (e) {
                reject(e);
            }
        }

        Promise.prototype.then = function (onResolved, onRejected) {
            const self = this;
            if (typeof onRejected !== 'function') {
                onRejected = reason => {
                    throw reason;
                }
            }
            if (typeof onResolved !== 'function') {
                onResolved = value => value;
            }
            return new Promise((resolve, reject) => {
                function callback(type) {
                    try {
                        let result = type(self.PromiseResult);
                        if (result instanceof Promise) {
                            result.then(v => {
                                resolve(v)
                            }, r => {
                                resolve(r)
                            })
                        } else {
                            resolve(result)
                        }
                    } catch (e) {
                        reject(e)
                    }
                }
                if (this.PromiseState === 'fulfilled') {
                    setTimeout(() => {
                        callback(onResolved)
                    })
                }
                if (this.PromiseState === 'rejected') {
                    setTimeout(() => {
                        callback(onRejected)
                    })
                }
                if (this.PromiseState === 'pending') {
                    self.callbacks.push({
                        onResolved: () => {
                            callback(onResolved)
                        },
                        onRejected: () => {
                            callback(onRejected)
                        },
                    })
                }
            })
        }

        Promise.prototype.catch = function (onRejected) {
            return this.then(undefined, onRejected)
        }
        Promise.resolve = function (value) {
            return new Promise((resolve, reject) => {
                if (value instanceof Promise) {
                    value.then(
                        v => resolve(v),
                        r => reject(r)
                    )
                } else {
                    resolve(value)
                }

            })
        }
        Promise.reject = function (value) {
            return new Promise((resolve, reject) => {
                reject(value)
            })
        }
        Promise.all = function (promises) {
            return new Promise((resolve, reject) => {
                let count = 0;
                let arr = [];
                for (let i = 0; i < promises.length; i++) {
                    promises[i].then(v => {
                        count++;
                        arr[i] = v;
                        if (count === promises.length) {
                            resolve(arr);
                        }
                    }, r => {
                        reject(r)
                    })
                }
            })
        }
        Promise.race = function (promises) {
            return new Promise((resolve, reject) => {
                for (let i = 0; i < promises.length; i++) {
                    promises[i].then(v => {
                        resolve(v);
                    }, r => {
                        reject(r);
                    })
                }
            })
        }
        let p = new Promise((resolve, reject) => {
            setTimeout(() => {
                resolve('ok');
                reject('error');
                // throw 'ERROR'
            }, 1000)
        });
        // console.log(p);

        // const res = p.then(value => {
        //     console.log("then value", value);
        // }, reason => {
        //     console.warn("then reason", reason);
        // })
        // console.log(res);

        // let result = p.catch(reason => {
        //     console.warn("catch reason", reason);
        // });
        const result = p.then(value => {
            console.log(1);
            throw 'ERROR'
        }).then(value => {
            console.log(2);
            // throw 'ERROR'
        }).then(value => {
            console.log(3);
        }).catch(reason => {
            console.warn("catch reason", reason);
        });
        console.log(result);

        const p1 = Promise.resolve('p1ok')
        console.log(p1);

        const p11 = Promise.resolve('p11ok')
        console.log(p11);

        const p111 = Promise.resolve('p111ok')
        console.log(p111);

        const p2 = Promise.resolve(new Promise((resolve, reject) => {
            resolve('p2ok');
            // reject('p2error');
            // throw 'ERROR'
        }))
        console.log(p2);

        const p3 = Promise.reject(new Promise((resolve, reject) => {
            resolve('p3ok');
            // reject('p2error');
            // throw 'ERROR'
        }));
        const all = Promise.all([p1, p11, p111])
        const race = Promise.race([p1, p11, p111])
        console.log('Promise.all', race);
        console.log('Promise.race', race);

        let p1p = new Promise((resolve, reject) => {
            console.log(000);
            resolve('ok');
            console.log(111);
        })
        p1p.then(value => {
            console.log(222);
        })
        console.log(333);
    </script>
</head>

<body>

</body>

</html>
